/*
 * Copyright (c) Orchestral Developments Ltd (2001 - 2014).
 *
 * This document is copyright. Except for the purpose of fair reviewing, no part
 * of this publication may be reproduced or transmitted in any form or by any
 * means, electronic or mechanical, including photocopying, recording, or any
 * information storage and retrieval system, without permission in writing from
 * the publisher. Infringers of copyright render themselves liable for
 * prosecution.
 */
YUI.add("ohp-activity-timeout",function(e,t){"use strict";function d(e){var t=e||r,i=t.parent,s;if(t===t.top)return null;if(!n.isUndefined(i.YUI)){s=i.YUI.namespace("OHP.ActivityTimeout");if(s._instance)return s._instance}return d(i)}var n=e.Lang,r=e.config.win,i=e.config.doc,s="ohp-activity-timeout-action",o=new e.COW.ActivitySyncer(s),u=6e4,a="displayWarning",f="warningDismissed",l="warningTimeout",c=YUI.namespace("OHP.ActivityTimeout"),h,p;p=d(),h=e.Base.create("ohp-activity-timeout",e.Base,[],{initializer:function(){this._eventSubscriptions=[],e.publish("ohp-activity-timeout:activityTimeout",{broadcast:2}),e.publish("ohp-activity-timeout:warningTimeout",{broadcast:2}),this._pingIo=new e.IO,this._cleanCurrentAction()},destructor:function(){this._disableActivityTimeout(),this._activityTimeoutDetector&&this._activityTimeoutDetector.destroy(),this._activityTimeoutWarningPanel&&this._activityTimeoutWarningPanel.destroy(),this._storageChangeEventListener&&o.detachListener(this._storageChangeEventListener)},configureAndStart:function(t){return this._activityTimeoutEnabled||p?!1:(this._activityTimeoutDetector=new e.OHP.ActivityTimeout.Detector({timeout:t.timeout}),this._activityTimeoutWarningPanel=new e.OHP.ActivityTimeout.WarningPanel,this._set("logoutFn",t.logoutFn||function(){}),t.pingUrl&&this._set("pingUrl",t.pingUrl),t.pingInterval&&this._set("pingInterval",t.pingInterval),this._enableActivityTimeout(),!0)},isAutomaticallyLoggingOut:function(){return p?p.isAutomaticallyLoggingOut():this.get("automaticallyLoggingOut")},_enableActivityTimeout:function(){this._activityTimeoutDetector.start(),this._activityTimeoutWarningPanel.render(),this.get("pingUrl")&&(this._keepAliveTimer=e.later(this.get("pingInterval"),this,this._onPingIntervalDoPing,[],!0)),this._eventSubscriptions.push(e.Global.on("ohp-activity-timeout:activityTimeout",this._onActivityTimeoutShowWarningPanel,this),e.Global.on("ohp-activity-timeout:warningTimeout",this._onWarningTimeoutInitiateLogout,this),e.Global.on("ohp-activity-timeout:warningDismissed",this._onWarningDismissedCommunicateDismiss,this)),this._storageChangeEventListener=e.bind(this._actionStorageChangeHandler,this),o.attachListener(this._storageChangeEventListener),this._activityTimeoutEnabled=!0},_onPingIntervalDoPing:function(){this._pingIo.send(this.get("pingUrl"))},_onActivityTimeoutShowWarningPanel:function(){this._initiateAction(a),this._activityTimeoutWarningPanel.show()},_onWarningTimeoutInitiateLogout:function(){this._initiateAction(l),this._performLogout()},_onWarningDismissedCommunicateDismiss:function(){this._initiateAction(f)},_actionStorageChangeHandler:function(t){var n=t.value;n===a?e.fire("ohp-activity-timeout:activityTimeout"):n===f?this._activityTimeoutWarningPanel.dismiss():n===l&&!this.get("automaticallyLoggingOut")&&e.fire("ohp-activity-timeout:warningTimeout")},_initiateAction:function(t){var n=o.get();n!==t&&(o.broadcast(t),e.later(1e3,this,this._cleanCurrentAction))},_cleanCurrentAction:function(){o.clear()},_performLogout:function(){if(this.get("automaticallyLoggingOut"))return;this._set("automaticallyLoggingOut",!0),this._cancelKeepAliveTimer(),this.get("logoutFn")()},_cancelKeepAliveTimer:function(){this._keepAliveTimer&&this._keepAliveTimer.cancel()},_disableActivityTimeout:function(){e.Array.invoke(this._eventSubscriptions,"detach"),this._activityTimeoutDetector.stop(),this._activityTimeoutWarningPanel.hide(),this._cancelKeepAliveTimer(),this._activityTimeoutEnabled=!1}},{ATTRS:{pingUrl:{readOnly:!0},pingInterval:{value:u,readOnly:!0},logoutFn:{readOnly:!0},automaticallyLoggingOut:{readOnly:!0,value:!1}}}),c._instance||(c._instance=new h),e.namespace("OHP").ActivityTimeout=e.mix(c._instance,e.namespace("OHP.ActivityTimeout"))},"7.9.0",{requires:["base","node-base","event-base","event-custom","yui-later","array-invoke","io-base","ohp-activity-timeout-detector","ohp-activity-timeout-warning-panel","ohp-activity-tracker","cow-activity-syncer"]});
