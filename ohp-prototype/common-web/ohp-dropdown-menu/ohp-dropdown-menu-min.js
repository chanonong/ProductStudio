/*
 * Copyright (c) Orchestral Developments Ltd (2001 - 2014).
 *
 * This document is copyright. Except for the purpose of fair reviewing, no part
 * of this publication may be reproduced or transmitted in any form or by any
 * means, electronic or mechanical, including photocopying, recording, or any
 * information storage and retrieval system, without permission in writing from
 * the publisher. Infringers of copyright render themselves liable for
 * prosecution.
 */
YUI.add("ohp-dropdown-menu",function(e,t){"use strict";var n,r=e.OHP.OhpClassNameManager.getClassName,i=e.Lang,s=e.OHP.Locale,o={dropdownMenuActive:r("dropdown","menu","active"),item:r("dropdown","menu","item"),itemContent:r("dropdown","menu","item","content"),itemContentActive:r("dropdown","menu","item","content","active")},u={itemId:"item-id",itemIndex:"item-index"},a="itemClick",f=3e3,l=[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL],c=e.Template.get("ohp-dropdown-menu-item-template");n=e.Base.create("ohpDropdownMenu",e.Widget,[e.WidgetPosition,e.WidgetStack,e.WidgetPositionAlign,e.WidgetPositionConstrain],{CONTENT_TEMPLATE:"<ul></ul>",_menuItemMap:{},initializer:function(){this._publishedEvents={},this._menuVisibleEventHandles=[]},destructor:function(){this.get("contentBox").unplug(e.Plugin.NodeFocusManager),e.Array.invoke(this._eventHandles,"detach"),e.each(this._publishedEvents,function(e){e.detach()}),this._detachMenuVisibleEvents()},renderUI:function(){var t=this.get("boundingBox"),n=this.get("contentBox"),r=this.get("items"),i=this.get("triggerNode");t.setAttrs({"aria-hidden":!0,role:"menu",tabIndex:null}),this._menuItemMap={},n.empty(),e.each(r,function(t,r){var i=e.guid();this._menuItemMap[i]=t,n.append(c({id:i,index:""+r,labelHtml:t.labelHtml,label:t.label,href:t.url||"#",target:t.target,classNames:o,dataAttrNames:u}))},this),this._menuStatusNode=e.one("#ohp-menu-status-node"),this._menuStatusNode||(this._menuStatusNode=e.Node.create('<span id="ohp-menu-status-node" class="ohp-screen-reader-only" role="status" aria-live="polite"></span>'),e.one("body").append(this._menuStatusNode)),i&&(i.get("tabIndex")||i.set("tabIndex",0),i.setAttrs({role:"button","aria-haspopup":!0}))},bindUI:function(){var t=this.get("contentBox"),n=this.get("triggerNode");t.plug(e.Plugin.NodeFocusManager,{descendants:"."+o.itemContent,keys:{next:"down:40",previous:"down:38"},focusClass:o.itemContentActive,circular:!0}),t.focusManager.after("focusedChange",this._afterFocusedChangeHideIfBlurred,this),e.Event.defineOutside("touchstart"),this._eventHandles=[t.delegate("click",this._onItemContentNodeClick,"."+o.itemContent,this),t.delegate("key",this._hideMenuAndFocusTriggerNode,"down:esc","."+o.itemContent,this),t.delegate("mouseenter",this._onItemContentNodeHoverSetFocus,"."+o.item,this),this.after("visibleChange",this._afterVisibleChange,this)],n&&(this._eventHandles.push(n.on("click",this._onTriggerNodeClickToggleMenu,this)),this._eventHandles.push(n.on("keydown",this._onTriggerNodeKeyPress,this)))},_publishAndFireEvent:function(e,t,n){this._publishedEvents[e]||(this._publishedEvents[e]=this.publish(e,t)),this.fire(e,n)},_alertScreenReaderOfMenuShown:function(){this._menuStatusNode.setHTML(s.get("cow.dropdownmenu.tooltip.screenReader.show")),e.later(f,this,function(){this._menuStatusNode.setHTML("")})},_detachMenuVisibleEvents:function(){e.Array.invoke(this._menuVisibleEventHandles,"detach"),this._menuVisibleEventHandles=[]},_getAlign:function(e){return e||{align:this.get("triggerNode"),points:l}},_hideMenuAndFocusTriggerNode:function(){var e=this.get("triggerNode");this.hide(),e&&e.focus()},_setAlign:function(t){var n={};if(!t||!t.points)n.points=l;if(!t||!t.node)n.node=this.get("triggerNode");return e.merge(t,n)},_afterFocusedChangeHideIfBlurred:function(e){e.newVal||this.hide()},_afterVisibleChange:function(t){var n=t.newVal,r=this.get("boundingBox"),i=this.get("triggerNode");n?(this._menuVisibleEventHandles=[r.on("clickoutside",this._onClickOrTouchOutsideHide,this),r.on("touchstartoutside",this._onClickOrTouchOutsideHide,this)],e.later(100,this,this._afterShowMenuBindWindowResize),this._alertScreenReaderOfMenuShown()):(this._detachMenuVisibleEvents(),this.get("contentBox").focusManager.set("activeDescendant",0)),i&&i[n?"addClass":"removeClass"](o.dropdownMenuActive),r.set("aria-hidden",!n)},_afterShowMenuBindWindowResize:function(){this.get("visible")&&this._menuVisibleEventHandles.push(e.on("resize",this._hideMenuAndFocusTriggerNode,e.config.win,this))},_onClickOrTouchOutsideHide:function(e){var t=this.get("triggerNode"),n=e.target;t&&!n.compareTo(t)&&!t.contains(n)&&this.hide()},_onItemContentNodeClick:function(e){var t=this._menuItemMap[e.currentTarget.getData(u.itemId)];t.url||e.preventDefault(),this._hideMenuAndFocusTriggerNode(),this._publishAndFireEvent(a,{emitFacade:!0},{originEvent:e,item:t})},_onItemContentNodeHoverSetFocus:function(e){var t=parseInt(e.currentTarget.getData(u.itemIndex),10);this.get("contentBox").focusManager.focus(t)},_onTriggerNodeClickToggleMenu:function(e){e.preventDefault(),this.set("visible",!this.get("visible"))},_onTriggerNodeKeyPress:function(e){e.keyCode===40&&this.get("visible")?(e.preventDefault(),this.get("contentBox").focusManager.focus(0)):(e.keyCode===27||e.shiftKey&&e.keyCode===9)&&this.hide()}},{ATTRS:{items:{validator:i.isArray,writeOnce:"initOnly"},triggerNode:{value:null,setter:e.one,writeOnce:"initOnly"},align:{getter:"_getAlign",setter:"_setAlign"},visible:{value:!1},zIndex:{value:2}},CSS_PREFIX:r("dropdown","menu")}),e.namespace("OHP").DropdownMenu=n},"7.9.0",{requires:["array-invoke","base","event-key","event-mouseenter","event-outside","event-resize","event-touch","node-base","node-event-delegate","node-focusmanager","template-base","widget","widget-position","widget-position-align","widget-position-constrain","widget-stack","ohp-locale-base","ohp-locale-translations","ohp-ohp-class-name-manager","ohp-dropdown-menu-templates"],skinnable:!0});
