/*
 * Copyright (c) Orchestral Developments Ltd (2001 - 2014).
 *
 * This document is copyright. Except for the purpose of fair reviewing, no part
 * of this publication may be reproduced or transmitted in any form or by any
 * means, electronic or mechanical, including photocopying, recording, or any
 * information storage and retrieval system, without permission in writing from
 * the publisher. Infringers of copyright render themselves liable for
 * prosecution.
 */
YUI.add("ohp-activity-timeout-detector",function(e,t){"use strict";var n,r=e.config.win,i=e.config.doc,s=new e.COW.ActivitySyncer(YUI.OHP.ActivityTracker.ACTIVITY_STORAGE_KEY),o=6e5;e.mix(e.Node.DOM_EVENTS,{visibilitychange:!0}),n=e.Base.create("ohp-activity-timeout-detector",e.Base,[],{initializer:function(){this._detectorStarted=!1,this._activityTimeoutOccurred=!1,this._eventSubscriptions=[],e.publish("ohp-activity-timeout:activityTimeout",{broadcast:2})},destructor:function(){this.stop()},start:function(){if(this._detectorStarted)return;this._eventSubscriptions.push(e.Global.on("ohp-activity-tracker:activityDetected",this._onActivityDetected,this),e.Global.on("ohp-activity-timeout:warningDismissed",this._restartTimer,this),e.one(i).on("visibilitychange",this._onPageVisibilityChange,this)),this._storageChangeEventListener=e.bind(this._onLocalStorageChange,this),s.attachListener(this._storageChangeEventListener),this._startTimer(),this._detectorStarted=!0},_startTimer:function(){this._activityTimeoutTimer=e.later(this.get("timeout"),this,this._onTimeoutTimerExpiry)},_onTimeoutTimerExpiry:function(){this._activityTimeoutOccurred=!0,e.fire("ohp-activity-timeout:activityTimeout")},_cancelTimer:function(){this._activityTimeoutOccurred=!1,this._activityTimeoutTimer&&this._activityTimeoutTimer.cancel()},_restartTimer:function(){this._cancelTimer(),this._startTimer()},_onActivityDetected:function(){this._activityTimeoutOccurred||this._restartTimer()},_onLocalStorageChange:function(){if(this._activityTimeoutOccurred)return;this._restartTimer()},_onPageVisibilityChange:function(){var t=e.Lang.now(),n=s.get(),r=this.get("timeout"),i;if(!n){e.Global.fire("ohp-activity-timeout:warningTimeout");return}i=t-n.timestamp,i>=r+e.OHP.ActivityTimeout.WarningPanel._WARNING_COUNT_DOWN_TIME?e.Global.fire("ohp-activity-timeout:warningTimeout"):i>r+1e3&&e.fire("ohp-activity-timeout:activityTimeout")},stop:function(){this._cancelTimer(),e.Array.invoke(this._eventSubscriptions,"detach"),this._storageChangeEventListener&&s.detachListener(this._storageChangeEventListener),this._detectorStarted=!1}},{ATTRS:{timeout:{value:o,writeOnce:"initOnly"}}}),e.namespace("OHP.ActivityTimeout").Detector=n},"7.9.0",{requires:["base","node-base","event-base","event-custom","yui-later","array-invoke","ohp-activity-tracker","json-parse","cow-activity-syncer"]});
