/*
 * Copyright (c) Orchestral Developments Ltd (2001 - 2014).
 *
 * This document is copyright. Except for the purpose of fair reviewing, no part
 * of this publication may be reproduced or transmitted in any form or by any
 * means, electronic or mechanical, including photocopying, recording, or any
 * information storage and retrieval system, without permission in writing from
 * the publisher. Infringers of copyright render themselves liable for
 * prosecution.
 */
YUI.add("yui2-orchestral-input",function(e,t){
/*!(C) ORCHESTRAL*/
var n=e.YUI2,r=n.ORCHESTRAL;n.namespace("ORCHESTRAL.widget"),function(){function f(e){return i.isNumber(e)&&e>=0}var e=n.util.Dom,t=n.util.Event,i=n.lang,s=n.util.KeyListener.KEY,o=r.util.Locale,u=1e3,a=/\r?\n|<br\s*\/?>/gi,l=function(t,r){var s=e.get(t);if(!s){n.log("No element passed to Input constructor","warn");return}if(s.tagName!=="TEXTAREA"&&(s.tagName!=="INPUT"||s.type!=="text"))return;this._previousValue=e.get(t).value,e.generateId(s),this._hint=document.createElement("div"),e.addClass(this._hint,"hint"),e.insertAfter(this._hint,s),this._overlay=new n.widget.Overlay(this._hint,{context:[s,"br","tr"]}),this._overlay.hide(),l.superclass.constructor.call(this,t,r),!this.get("maxlength")&&n.util.Dom.getAttribute(s,"maxlength")&&this.set("maxlength",+n.util.Dom.getAttribute(s,"maxlength")),i.later(200,this,this._checkForUpdate,null,!0),i.later(1,this,this._checkForUpdate)};i.extend(l,n.util.Element,{initAttributes:function(h){l.superclass.initAttributes.call(this,h),this.setAttributeConfig("minheight",{validator:f,setter:function(e,t){return this._resolveHeights(e,t)},value:50}),this.setAttributeConfig("maxheight",{validator:f,setter:function(e,t){return this._resolveHeights(e,t)},value:200}),this.setAttributeConfig("maxlength",{validator:i.isNumber,method:function(t){var n=o.get("widget.input.singleCharacterRemaining"),r=o.get("widget.input.multipleCharactersRemaining"),s=o.get("widget.input.singleCharacterTooMany"),a=o.get("widget.input.multipleCharactersTooMany"),f="hint-warning",l=function(e){return document.activeElement?e===document.activeElement:e===document.focusNode},c=function(){var t=this.get("element"),o=t.value,c=this._getCharsRemaining(o),h="";if(o.length===0||c>u||c>=0&&!l(t))this._hideHint();else{var p=e.hasClass(this._hint,f);c<0&&!p?e.addClass(this._hint,f):c>=0&&p&&e.removeClass(this._hint,f),c===1?h=n:c>=0?h=r:c===-1?h=s:h=a,this._showHint(i.substitute(h,[Math.abs(c)]))}};this.subscribe("update",c,null,this),this.on("blur",function(){this._getCharsRemaining(this.get("element").value)>=0&&this._hideHint()},this,!0),this._getCharsRemaining(this.get("element").value)<0&&c.apply(this)}}),this.setAttributeConfig("resizable",{validator:function(e){return this.get("element").tagName==="TEXTAREA"&&i.isBoolean(e)},method:function(t){var n=this.get("element");if(t){this.setStyle("overflow","hidden"),this.setStyle("resize","none"),this.setStyle("min-height",this.get("minheight")+"px"),this._clone=n.cloneNode(!0),this._clone.removeAttribute("id"),this._clone.removeAttribute("name"),e.insertAfter(this._clone,n),e.addClass(this._clone,"cow-off-screen-shim-element"),e.addClass(this._clone,"ohp-hidden"),e.setStyle(this._clone,"height","0"),e.setStyle(this._clone,"min-height","0");if(r.env.ua.webkit){var i=n.value;n.value="",n.value=i,this._clone.value="",this._clone.value=i}this._clone.tabIndex=-1,this.subscribe("update",this.resize,null,this),this.resize()}else this._clone&&(this._clone.parentNode.removeChild(this._clone),this._clone=null),this.unsubscribe("update",this.resize)},value:!1}),this.setAttributeConfig("dataSource",{validator:function(e){return e instanceof n.util.DataSourceBase},method:function(r){var i=o.get("widget.input.quickTextHint"),u=r,f,l;f=new n.widget.Menu(e.generateId(),{classname:"OrchestralTextExpansionMenu",maxheight:250,position:"dynamic",zIndex:3}),this.on("focus",function(){if(!this.get("maxlength")||this._getCharsRemaining(this.get("element").value)>=0)e.removeClass(this._hint,"hint-warning"),this._showHint(i)},this,!0),this.on("blur",function(){(!this.get("maxlength")||this._getCharsRemaining(this.get("element").value)>=0)&&this._hideHint()},this,!0),l=function(e){return t.getCharCode(e)===s.ENTER&&e.ctrlKey},this.on("keydown",function(e){var n=t.getCharCode(e),r=null,i;if(!f.cfg.getProperty("visible")){l(e)&&t.stopEvent(e);return}switch(n){case s.UP:case s.DOWN:t.stopEvent(e),r=f.activeItem;if(r===null){n===s.UP?f.hide():f.getItems()[0].cfg.setProperty("selected",!0);break}i=f.getItems().length>1?r["get"+(n===s.UP?"Previous":"Next")+"EnabledSibling"]():r,n===s.UP&&i.index<r.index||n===s.DOWN&&i.index>r.index?(f.clearActiveItem(),i.cfg.setProperty("selected",!0)):n===s.UP&&f.clearActiveItem();break;case s.ENTER:case s.TAB:r=f.activeItem,r&&f.activeItem.clickEvent.fire(),t.stopEvent(e),f.hide();break;case s.ESCAPE:case s.SPACE:t.stopEvent(e),f.hide();break;case s.DELETE:t.stopEvent(e);return;case s.LEFT:c.getSelection(this.get("element")).text===""&&f.hide()}}),this.on("keyup",function(e){var r=t.getCharCode(e),i,h,p,d;if(!f.cfg.getProperty("visible")&&!l(e))return;switch(r){case s.UP:case s.DOWN:case s.CONTROL:return;default:i=c.getSelection(this.get("element")),h=i.text,p=i.getXY(),d=!f.cfg.getProperty("visible"),f.clearContent(),f.addItem(new n.widget.MenuItem("&nbsp;",{disabled:!0,classname:"Throbber Active"})),f.render(this.get("element").parentNode),f.setInitialSelection(),f.show(),f.moveTo(p[0],p[1]),u.sendRequest(this.get("paramName")+"="+h,{success:function(e,t){var r=this,s,u,l,c,v,m,g;if(t!==null){f.clearContent(),u=t.results.length;if(u===0)f.addItem(new n.widget.MenuItem(o.get("widget.input.noQuickTextMatches"),{disabled:!0}));else{if(u===1&&h.toLowerCase()===t.results[0].code.toLowerCase()&&d){s=t.results[0].value.replace(a,"\n"),i.replace(s),this.fireEvent("textExpanded",s),this.fireEvent("update"),f.hide();return}l=function(e,t,n){var s=n.text.replace(a,"\n");i.replace(s),r.fireEvent("textExpanded",s),r.fireEvent("update"),f.hide()};for(c=0;c<u;c+=1)v=t.results[c],m=v.code.substr(0,h.length),g=v.code.substr(h.length),f.addItem(new n.widget.MenuItem(v.value,{onclick:{fn:l,obj:{text:v.value}},text:"<strong>"+m+"</strong>"+g+" - "+r._escapeMenuItem(v.value),selected:c===0}))}}f.render(this.get("element").parentNode),f.setInitialSelection(),f.show(),f.moveTo(p[0],p[1])},failure:function(e,t){n.log
("Request to dataSource failed: "+t.statusText,"error")},scope:this})}}),this.on("keypress",function(e){if(!f.cfg.getProperty("visible"))return;switch(t.getCharCode(e)){case s.UP:case s.DOWN:case s.DELETE:t.stopEvent(e);return}})}}),this.setAttributeConfig("paramName",{validator:i.isString,value:"text"})},destroy:function(){t.purgeElement(this.get("element"),!0),this._overlay.hide();for(var e=0;e<this._interval.length;e++)this._interval[e]&&this._interval[e].cancel()},_hint:null,_overlay:null,_interval:[],_lastScrollTop:null,_previousValue:null,_previousHeight:0,_clone:null,_escapeMenuItem:function(e){var t=e.split(a),n=[],i;for(i=0;i<t.length;i+=1)n.push(r.lang.escapeHtml(t[i]));return n.join("&para;")},_getElementWidth:function(){return r.env.ua.ie&&r.env.ua.ie<9?this._getCalculatedElementWidth():e.getComputedStyle(this.get("element"),"width")},_getCalculatedElementWidth:function(){var t=this.get("element"),n=parseInt(t.offsetWidth,10),i,s,o,u,a;return n===0?e.getComputedStyle(t,"width"):(r.env.ua.ie===6?(i=1,s=1):(i=parseInt(e.getComputedStyle(t,"borderLeftWidth"),10),s=parseInt(e.getComputedStyle(t,"borderRightWidth"),10)),o=parseInt(e.getComputedStyle(t,"paddingLeft"),10),u=parseInt(e.getComputedStyle(t,"paddingRight"),10),a=n-i-s-o-u+"px",a)},resize:function(){var t=this.get("element"),n=this.get("maxheight"),r=this.get("minheight"),s,o,u,a;s=16;if(t.offsetWidth===0&&t.offsetHeight===0||this.getStyle("display")==="none"){i.later(500,this,this.resize);return}e.removeClass(this._clone,"ohp-hidden"),this._clone.value=t.value,this._clone.scrollTop=1e5,e.setStyle(this._clone,"overflow-y",this.getStyle("overflow-y")),e.setStyle(this._clone,"width",this.getStyle("width")),o=this._clone.scrollHeight,o>n?(u=n,a="auto"):o+s>n?(u=n,a="hidden"):(u=Math.max(o+s,r),a="hidden"),this.setStyle("height",u+"px"),this.setStyle("overflow-y",a),e.addClass(this._clone,"ohp-hidden")},_positionHint:function(){this._overlay.align("br","tr",[0,1])},_showHint:function(t){this._hint.innerHTML=t,this._positionHint(),this._overlay.show(),e.setStyle(this._hint,"visibility","inherit");var n=this.get("element").id;this._interval[n]||(this._interval[n]=i.later(200,this,this._positionHint,null,!0))},_hideHint:function(){var e=this.get("element").id;this._overlay.hide(),this._interval[e]&&(this._interval[e].cancel(),this._interval[e]=null)},_checkForUpdate:function(){var e=this.get("element"),t=e.value,n=this._previousValue;if(n===null||t!=n)this._previousValue=t,this.fireEvent("update")},_resolveHeights:function(e,t){var n,r;if(t==="minheight")return n=e,r=this.get("maxheight"),n>r&&this.set("maxheight",n),n;if(t==="maxheight")return n=this.get("minheight"),r=e,n>r?n:r},_getCharsRemaining:function(e){var t=e.replace(/(\r\n|\r|\n)/g,"\r\n"),n=this.get("maxlength");return n?n-t.length:0}}),r.widget.Input=l;var c=function(t,n,r,i,s,o){this.text=t||"",this._element=e.get(n),this._start=r,this._end=i,this._x=s,this._y=o};c.prototype={replace:function(t){var n=this._element.scrollTop;if(document.selection){this._element.focus();var r=document.selection.createRange();this.text!=r.text&&r.moveStart("character",-1*this.text.length),r.text=t,r.select(),r.moveEnd("character",t.length),r.moveStart("character",t.length)}else{this._element.value=this._element.value.substr(0,this._start)+t+this._element.value.substr(this._end,this._element.value.length),this._element.select(),this._element.focus();var i=this._start+t.length;this._element.setSelectionRange(i,i);var s=c.getSelection(this._element).getXY()[1]-e.getY(this._element)-this._element.offsetHeight;this._element.scrollTop=Math.max(n,s)}this.text=t},getXY:function(){var t=e.getXY(this._element),i=document.createElement("div");e.setStyle(i,"border","1px solid gray"),e.setStyle(i,"padding","2px"),e.setStyle(i,"font-family",e.getStyle(this._element,"font-family")),e.setStyle(i,"font-weight",e.getStyle(this._element,"font-weight")),e.setStyle(i,"overflow",n.env.ua.ie?"scroll":"auto"),e.setStyle(i,"font-size",e.getStyle(this._element,"font-size")),e.setStyle(i,"width",this._element.offsetWidth-c.WIDTH_OFFSET+"px"),e.setStyle(i,"height",this._element.offsetHeight+"px"),i.innerHTML=r.lang.escapeHtml(this._element.value.substr(0,this._start)).replace(/\n/g,"<br>")+'<span class="cursor">&nbsp;</span>',this._element.parentNode.appendChild(i);var s=e.getElementsByClassName("cursor","span",i)[0],o=e.getXY(i),u=e.getXY(s),a=[u[0]-o[0],u[1]-o[1]-this._element.scrollTop];return this._element.parentNode.removeChild(i),[t[0]+a[0],t[1]+a[1]+c.PADDING]}},i.augmentObject(c,{PADDING:17,WIDTH_OFFSET:8,getSelection:function(e){var t="",n=-1,r=-1,i=null;if(document.selection){i=document.selection.createRange(),e.value!==""&&(i.text.length>0?t=i.text:(i.moveStart("character",-1),i.text.length===1?/\W/.test(i.text.charAt(0))?(i.moveStart("character",1),t=""):(i.moveStart("character",1),i.moveStart("word",-1),t=i.text):i.moveStart("character",1),t=i.text));if(e.tagName==="TEXTAREA"){var s=i.duplicate();s.moveToElementText(e),s.setEndPoint("EndToEnd",i),n=s.text.length-t.length,r=s.text.length}else n=i.offsetLeft-1,r=t.length;return new c(t,e,n,r,i.offsetLeft,i.offsetTop)}var o=0;n=e.selectionStart,r=e.selectionEnd;if(n===r){o--;var u=0;while((u=n+o)>-1&&!/\W/.test(e.value.charAt(u)))o--;o++}return n+=o,i=document.createRange(),i.setStart(e,0),i.setEnd(e,0),t=e.value.substring(n,r),new c(e.value.substring(n,r),e,n,r)}}),r.widget.ResizingTextarea=function(e,t){var i=n.lang.merge({resizable:!0},t||{});return i.minHeight&&(i.minheight=i.minHeight,delete i.minHeight),i.maxHeight&&(i.maxheight=i.maxHeight,delete i.maxHeight),new r.widget.Input(e,i)},r.widget.TextExpansion=function(e,t,i){var s=n.lang.merge({dataSource:t},i||{});return new r.widget.Input(e,s)},r.widget.ConstrainedTextarea=function(e){if(!n.lang.isArray(e))return e=n.util.Dom.get(e),new r.widget.Input(e);for(var t=0;t<e.length;t++)new r.widget.ConstrainedTextarea(e[t])}}(),n.register("orchestral-input",r.widget.Input,{version:"7.9",build:"0"})},"7.9.0"
,{requires:["yui2-yahoo","yui2-dom","yui2-event","yui2-element","yui2-container","yui2-menu","yui2-orchestral","ohp-locale-translations"]});
