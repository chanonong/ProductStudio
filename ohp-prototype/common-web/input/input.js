/*
 * Copyright (c) Orchestral Developments Ltd (2001 - 2014).
 *
 * This document is copyright. Except for the purpose of fair reviewing, no part
 * of this publication may be reproduced or transmitted in any form or by any
 * means, electronic or mechanical, including photocopying, recording, or any
 * information storage and retrieval system, without permission in writing from
 * the publisher. Infringers of copyright render themselves liable for
 * prosecution.
 */
YAHOO.namespace("ORCHESTRAL.widget"),function(){function u(e){return n.isNumber(e)&&e>=0}var e=YAHOO.util.Dom,t=YAHOO.util.Event,n=YAHOO.lang,r=YAHOO.util.KeyListener.KEY,i=ORCHESTRAL.util.Locale,s=1e3,o=/\r?\n|<br\s*\/?>/gi,a=function(t,r){var i=e.get(t);if(!i)return;if(i.tagName!=="TEXTAREA"&&(i.tagName!=="INPUT"||i.type!=="text"))return;this._previousValue=e.get(t).value,e.generateId(i),this._hint=document.createElement("div"),e.addClass(this._hint,"hint"),e.insertAfter(this._hint,i),this._overlay=new YAHOO.widget.Overlay(this._hint,{context:[i,"br","tr"]}),this._overlay.hide(),a.superclass.constructor.call(this,t,r),!this.get("maxlength")&&YAHOO.util.Dom.getAttribute(i,"maxlength")&&this.set("maxlength",+YAHOO.util.Dom.getAttribute(i,"maxlength")),n.later(200,this,this._checkForUpdate,null,!0),n.later(1,this,this._checkForUpdate)};n.extend(a,YAHOO.util.Element,{initAttributes:function(l){a.superclass.initAttributes.call(this,l),this.setAttributeConfig("minheight",{validator:u,setter:function(e,t){return this._resolveHeights(e,t)},value:50}),this.setAttributeConfig("maxheight",{validator:u,setter:function(e,t){return this._resolveHeights(e,t)},value:200}),this.setAttributeConfig("maxlength",{validator:n.isNumber,method:function(t){var r=i.get("widget.input.singleCharacterRemaining"),o=i.get("widget.input.multipleCharactersRemaining"),u=i.get("widget.input.singleCharacterTooMany"),a=i.get("widget.input.multipleCharactersTooMany"),f="hint-warning",l=function(e){return document.activeElement?e===document.activeElement:e===document.focusNode},c=function(){var t=this.get("element"),i=t.value,c=this._getCharsRemaining(i),h="";if(i.length===0||c>s||c>=0&&!l(t))this._hideHint();else{var p=e.hasClass(this._hint,f);c<0&&!p?e.addClass(this._hint,f):c>=0&&p&&e.removeClass(this._hint,f),c===1?h=r:c>=0?h=o:c===-1?h=u:h=a,this._showHint(n.substitute(h,[Math.abs(c)]))}};this.subscribe("update",c,null,this),this.on("blur",function(){this._getCharsRemaining(this.get("element").value)>=0&&this._hideHint()},this,!0),this._getCharsRemaining(this.get("element").value)<0&&c.apply(this)}}),this.setAttributeConfig("resizable",{validator:function(e){return this.get("element").tagName==="TEXTAREA"&&n.isBoolean(e)},method:function(t){var n=this.get("element");if(t){this.setStyle("overflow","hidden"),this.setStyle("resize","none"),this.setStyle("min-height",this.get("minheight")+"px"),this._clone=n.cloneNode(!0),this._clone.removeAttribute("id"),this._clone.removeAttribute("name"),e.insertAfter(this._clone,n),e.addClass(this._clone,"cow-off-screen-shim-element"),e.addClass(this._clone,"ohp-hidden"),e.setStyle(this._clone,"height","0"),e.setStyle(this._clone,"min-height","0");if(ORCHESTRAL.env.ua.webkit){var r=n.value;n.value="",n.value=r,this._clone.value="",this._clone.value=r}this._clone.tabIndex=-1,this.subscribe("update",this.resize,null,this),this.resize()}else this._clone&&(this._clone.parentNode.removeChild(this._clone),this._clone=null),this.unsubscribe("update",this.resize)},value:!1}),this.setAttributeConfig("dataSource",{validator:function(e){return e instanceof YAHOO.util.DataSourceBase},method:function(n){var s=i.get("widget.input.quickTextHint"),u=n,a,l;a=new YAHOO.widget.Menu(e.generateId(),{classname:"OrchestralTextExpansionMenu",maxheight:250,position:"dynamic",zIndex:3}),this.on("focus",function(){if(!this.get("maxlength")||this._getCharsRemaining(this.get("element").value)>=0)e.removeClass(this._hint,"hint-warning"),this._showHint(s)},this,!0),this.on("blur",function(){(!this.get("maxlength")||this._getCharsRemaining(this.get("element").value)>=0)&&this._hideHint()},this,!0),l=function(e){return t.getCharCode(e)===r.ENTER&&e.ctrlKey},this.on("keydown",function(e){var n=t.getCharCode(e),i=null,s;if(!a.cfg.getProperty("visible")){l(e)&&t.stopEvent(e);return}switch(n){case r.UP:case r.DOWN:t.stopEvent(e),i=a.activeItem;if(i===null){n===r.UP?a.hide():a.getItems()[0].cfg.setProperty("selected",!0);break}s=a.getItems().length>1?i["get"+(n===r.UP?"Previous":"Next")+"EnabledSibling"]():i,n===r.UP&&s.index<i.index||n===r.DOWN&&s.index>i.index?(a.clearActiveItem(),s.cfg.setProperty("selected",!0)):n===r.UP&&a.clearActiveItem();break;case r.ENTER:case r.TAB:i=a.activeItem,i&&a.activeItem.clickEvent.fire(),t.stopEvent(e),a.hide();break;case r.ESCAPE:case r.SPACE:t.stopEvent(e),a.hide();break;case r.DELETE:t.stopEvent(e);return;case r.LEFT:f.getSelection(this.get("element")).text===""&&a.hide()}}),this.on("keyup",function(e){var n=t.getCharCode(e),s,c,h,p;if(!a.cfg.getProperty("visible")&&!l(e))return;switch(n){case r.UP:case r.DOWN:case r.CONTROL:return;default:s=f.getSelection(this.get("element")),c=s.text,h=s.getXY(),p=!a.cfg.getProperty("visible"),a.clearContent(),a.addItem(new YAHOO.widget.MenuItem("&nbsp;",{disabled:!0,classname:"Throbber Active"})),a.render(this.get("element").parentNode),a.setInitialSelection(),a.show(),a.moveTo(h[0],h[1]),u.sendRequest(this.get("paramName")+"="+c,{success:function(e,t){var n=this,r,u,f,l,d,v,m;if(t!==null){a.clearContent(),u=t.results.length;if(u===0)a.addItem(new YAHOO.widget.MenuItem(i.get("widget.input.noQuickTextMatches"),{disabled:!0}));else{if(u===1&&c.toLowerCase()===t.results[0].code.toLowerCase()&&p){r=t.results[0].value.replace(o,"\n"),s.replace(r),this.fireEvent("textExpanded",r),this.fireEvent("update"),a.hide();return}f=function(e,t,r){var i=r.text.replace(o,"\n");s.replace(i),n.fireEvent("textExpanded",i),n.fireEvent("update"),a.hide()};for(l=0;l<u;l+=1)d=t.results[l],v=d.code.substr(0,c.length),m=d.code.substr(c.length),a.addItem(new YAHOO.widget.MenuItem(d.value,{onclick:{fn:f,obj:{text:d.value}},text:"<strong>"+v+"</strong>"+m+" - "+n._escapeMenuItem(d.value),selected:l===0}))}}a.render(this.get("element").parentNode),a.setInitialSelection(),a.show(),a.moveTo(h[0],h[1])},failure:function(e,t){},scope:this})}}),this.on("keypress",function(e){if(!a.cfg.getProperty("visible"))return;switch(t.getCharCode
(e)){case r.UP:case r.DOWN:case r.DELETE:t.stopEvent(e);return}})}}),this.setAttributeConfig("paramName",{validator:n.isString,value:"text"})},destroy:function(){t.purgeElement(this.get("element"),!0),this._overlay.hide();for(var e=0;e<this._interval.length;e++)this._interval[e]&&this._interval[e].cancel()},_hint:null,_overlay:null,_interval:[],_lastScrollTop:null,_previousValue:null,_previousHeight:0,_clone:null,_escapeMenuItem:function(e){var t=e.split(o),n=[],r;for(r=0;r<t.length;r+=1)n.push(ORCHESTRAL.lang.escapeHtml(t[r]));return n.join("&para;")},_getElementWidth:function(){return ORCHESTRAL.env.ua.ie&&ORCHESTRAL.env.ua.ie<9?this._getCalculatedElementWidth():e.getComputedStyle(this.get("element"),"width")},_getCalculatedElementWidth:function(){var t=this.get("element"),n=parseInt(t.offsetWidth,10),r,i,s,o,u;return n===0?e.getComputedStyle(t,"width"):(ORCHESTRAL.env.ua.ie===6?(r=1,i=1):(r=parseInt(e.getComputedStyle(t,"borderLeftWidth"),10),i=parseInt(e.getComputedStyle(t,"borderRightWidth"),10)),s=parseInt(e.getComputedStyle(t,"paddingLeft"),10),o=parseInt(e.getComputedStyle(t,"paddingRight"),10),u=n-r-i-s-o+"px",u)},resize:function(){var t=this.get("element"),r=this.get("maxheight"),i=this.get("minheight"),s,o,u,a;s=16;if(t.offsetWidth===0&&t.offsetHeight===0||this.getStyle("display")==="none"){n.later(500,this,this.resize);return}e.removeClass(this._clone,"ohp-hidden"),this._clone.value=t.value,this._clone.scrollTop=1e5,e.setStyle(this._clone,"overflow-y",this.getStyle("overflow-y")),e.setStyle(this._clone,"width",this.getStyle("width")),o=this._clone.scrollHeight,o>r?(u=r,a="auto"):o+s>r?(u=r,a="hidden"):(u=Math.max(o+s,i),a="hidden"),this.setStyle("height",u+"px"),this.setStyle("overflow-y",a),e.addClass(this._clone,"ohp-hidden")},_positionHint:function(){this._overlay.align("br","tr",[0,1])},_showHint:function(t){this._hint.innerHTML=t,this._positionHint(),this._overlay.show(),e.setStyle(this._hint,"visibility","inherit");var r=this.get("element").id;this._interval[r]||(this._interval[r]=n.later(200,this,this._positionHint,null,!0))},_hideHint:function(){var e=this.get("element").id;this._overlay.hide(),this._interval[e]&&(this._interval[e].cancel(),this._interval[e]=null)},_checkForUpdate:function(){var e=this.get("element"),t=e.value,n=this._previousValue;if(n===null||t!=n)this._previousValue=t,this.fireEvent("update")},_resolveHeights:function(e,t){var n,r;if(t==="minheight")return n=e,r=this.get("maxheight"),n>r&&this.set("maxheight",n),n;if(t==="maxheight")return n=this.get("minheight"),r=e,n>r?n:r},_getCharsRemaining:function(e){var t=e.replace(/(\r\n|\r|\n)/g,"\r\n"),n=this.get("maxlength");return n?n-t.length:0}}),ORCHESTRAL.widget.Input=a;var f=function(t,n,r,i,s,o){this.text=t||"",this._element=e.get(n),this._start=r,this._end=i,this._x=s,this._y=o};f.prototype={replace:function(t){var n=this._element.scrollTop;if(document.selection){this._element.focus();var r=document.selection.createRange();this.text!=r.text&&r.moveStart("character",-1*this.text.length),r.text=t,r.select(),r.moveEnd("character",t.length),r.moveStart("character",t.length)}else{this._element.value=this._element.value.substr(0,this._start)+t+this._element.value.substr(this._end,this._element.value.length),this._element.select(),this._element.focus();var i=this._start+t.length;this._element.setSelectionRange(i,i);var s=f.getSelection(this._element).getXY()[1]-e.getY(this._element)-this._element.offsetHeight;this._element.scrollTop=Math.max(n,s)}this.text=t},getXY:function(){var t=e.getXY(this._element),n=document.createElement("div");e.setStyle(n,"border","1px solid gray"),e.setStyle(n,"padding","2px"),e.setStyle(n,"font-family",e.getStyle(this._element,"font-family")),e.setStyle(n,"font-weight",e.getStyle(this._element,"font-weight")),e.setStyle(n,"overflow",YAHOO.env.ua.ie?"scroll":"auto"),e.setStyle(n,"font-size",e.getStyle(this._element,"font-size")),e.setStyle(n,"width",this._element.offsetWidth-f.WIDTH_OFFSET+"px"),e.setStyle(n,"height",this._element.offsetHeight+"px"),n.innerHTML=ORCHESTRAL.lang.escapeHtml(this._element.value.substr(0,this._start)).replace(/\n/g,"<br>")+'<span class="cursor">&nbsp;</span>',this._element.parentNode.appendChild(n);var r=e.getElementsByClassName("cursor","span",n)[0],i=e.getXY(n),s=e.getXY(r),o=[s[0]-i[0],s[1]-i[1]-this._element.scrollTop];return this._element.parentNode.removeChild(n),[t[0]+o[0],t[1]+o[1]+f.PADDING]}},n.augmentObject(f,{PADDING:17,WIDTH_OFFSET:8,getSelection:function(e){var t="",n=-1,r=-1,i=null;if(document.selection){i=document.selection.createRange(),e.value!==""&&(i.text.length>0?t=i.text:(i.moveStart("character",-1),i.text.length===1?/\W/.test(i.text.charAt(0))?(i.moveStart("character",1),t=""):(i.moveStart("character",1),i.moveStart("word",-1),t=i.text):i.moveStart("character",1),t=i.text));if(e.tagName==="TEXTAREA"){var s=i.duplicate();s.moveToElementText(e),s.setEndPoint("EndToEnd",i),n=s.text.length-t.length,r=s.text.length}else n=i.offsetLeft-1,r=t.length;return new f(t,e,n,r,i.offsetLeft,i.offsetTop)}var o=0;n=e.selectionStart,r=e.selectionEnd;if(n===r){o--;var u=0;while((u=n+o)>-1&&!/\W/.test(e.value.charAt(u)))o--;o++}return n+=o,i=document.createRange(),i.setStart(e,0),i.setEnd(e,0),t=e.value.substring(n,r),new f(e.value.substring(n,r),e,n,r)}}),ORCHESTRAL.widget.ResizingTextarea=function(e,t){var n=YAHOO.lang.merge({resizable:!0},t||{});return n.minHeight&&(n.minheight=n.minHeight,delete n.minHeight),n.maxHeight&&(n.maxheight=n.maxHeight,delete n.maxHeight),new ORCHESTRAL.widget.Input(e,n)},ORCHESTRAL.widget.TextExpansion=function(e,t,n){var r=YAHOO.lang.merge({dataSource:t},n||{});return new ORCHESTRAL.widget.Input(e,r)},ORCHESTRAL.widget.ConstrainedTextarea=function(e){if(!YAHOO.lang.isArray(e))return e=YAHOO.util.Dom.get(e),new ORCHESTRAL.widget.Input(e);for(var t=0;t<e.length;t++)new ORCHESTRAL.widget.ConstrainedTextarea(e[t])}}(),YAHOO.register("orchestral-input",ORCHESTRAL.widget.Input,{version:"7.9",build:"0"});
